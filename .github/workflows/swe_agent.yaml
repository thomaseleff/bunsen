# This workflow is triggered by the Bunsen issue-agent when a specific label
#   is added to a GitHub issue. It sets up the environment and runs the
#   Beaker swe-agent to process the issue.

name: Beaker (swe-agent)

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'The name of the GitHub repository.'
        required: true
        type: str
      repo_branch:
        description: 'The branch of the Github repository.'
        required: true
        type: str
      installation_id:
        description: 'The GitHub App installation ID to use for authentication.'
        required: true
        type: number
      issue_id:
        description: 'The id of the GitHub issue to process.'
        required: true
        type: number

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  build_and_run:
    runs-on: ubuntu-latest
    environment: swe-agent
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      BUNSEN_GITHUB_APP_ID: ${{ secrets.BUNSEN_GITHUB_APP_ID }}
      BUNSEN_GITHUB_PRIVATE_KEY: ${{ secrets.BUNSEN_GITHUB_PRIVATE_KEY }}
      BUNSEN_GITHUB_WEBHOOK_SECRET: ${{ secrets.BUNSEN_GITHUB_WEBHOOK_SECRET }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      LITELLM_DROP_PARAMS: True  # Usually required, depends on the supported model parameters

    steps:
      # Install the GitHub CLI
      - name: Install GitHub CLI
        run: sudo apt-get install -y gh

      # Check out the repository code
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.repo_branch }}
          path: bunsen

      # Check out swe-agent
      - name: Checkout swe-agent
        uses: actions/checkout@v4
        with:
          ref: v1.1.0  # Reference a release tag
          repository: SWE-agent/SWE-agent
          path: swe-agent

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # Upgrade pip
      - name: Upgrade pip
        run: |
          python -m pip install --upgrade pip

      # Install bunsen
      - name: Install bunsen
        run: |
          pip install ./bunsen

      # Install swe-agent
      - name: Install swe-agent
        run: |
          pip install --editable ./swe-agent

      # Run the swe-agent
      - name: Run swe-agent
        id: swe_task
        working-directory: ./bunsen
        run: python -m bunsen.swe_agent.agent --repo_name ${{ github.event.inputs.repo_name }} --installation_id ${{ github.event.inputs.installation_id }} --issue_id ${{ github.event.inputs.issue_id }}

      # Apply the patch and commit
      - name: Apply patch and commit
        id: apply_commit
        working-directory: ./bunsen
        env:
          PATCH_FILE: ${{ steps.swe_task.outputs.patch_path }}
          ISSUE_TITLE: ${{ 'beaker-swe-agent-issue-#' }}${{ github.event.inputs.issue_id }}
          BRANCH_NAME: ${{ 'beaker-swe-agent-issue-#' }}${{ github.event.inputs.issue_id }}
        if: ${{ steps.swe_task.outputs.exit_status == 'submitted' }}
        run: |

          # Create a branch and apply the patch
          git checkout -b "${BRANCH_NAME}"
          git apply "${PATCH_FILE}"

          # Setup beaker
          git config user.email 'beaker-swe-agent[bot]@users.noreply.github.com'
          git config user.name 'beaker-swe-agent[bot]'

          # Create the commit
          git add .
          git commit -m "Resolves #${{ github.event.inputs.issue_id }}"

          # Push the commit
          git push origin "${BRANCH_NAME}"

      # Open the pull request
      - name: Open pull request
        working-directory: ./bunsen
        env:
          ISSUE_TITLE: ${{ 'beaker-swe-agent-issue-#' }}${{ github.event.inputs.issue_id }}
          BRANCH_NAME: ${{ 'beaker-swe-agent-issue-#' }}${{ github.event.inputs.issue_id }}
        if: ${{ steps.swe_task.outputs.exit_status == 'submitted' }}
        run: |

          # Open the pull request
          gh pr create \
            --title "${ISSUE_TITLE}" \
            --body "$(cat <<EOF
          Closes #${{ github.event.inputs.issue_id }}

          Generated by the \`beaker-swe-agent\`, see the [bunsen](https://github.com/thomaseleff/bunsen) Github repository for more information.
          EOF
          )" \
            --head "${BRANCH_NAME}" \
            --base "${{ github.event.inputs.repo_branch }}" \
            --draft

          echo "Pull request opened successfully."